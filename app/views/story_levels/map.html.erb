<!-- app/views/story_levels/map.html.erb -->
<% content_for :hide_navbar, true %>

<% if flash[:level_10_complete] %>
  <div class="toast-notification">
    <div class="toast-body">
      <i class="fa-solid fa-trophy"></i> Last level Completed!
    </div>
  </div>
<% end %>

<div class="map-container" style="background-image: url('<%= asset_path(@current_level&.map_image || 'default.jpg') %>');">
  <div class="map-overlay" id="map-scroll" data-controller="scroll-to-current-level">
    <div class="map-header">
      <h1 class="map-title">Your Journey</h1>
      <p class="map-subtitle">
        <% if @all_complete %>
          All Levels Complete! <i class="fa-solid fa-crown"></i>
        <% else %>
          Level <%= @accessible_level_id %>
        <% end %>
      </p>
    </div>

    <div class="level-path">
      <% @story_levels.reverse_each do |level| %>
        <%
          is_completed = @completed_level_ids.include?(level.id)
          is_current   = level.id == @accessible_level_id
          is_locked    = level.id > @accessible_level_id
          is_final     = level.id == 10
        %>

        <div class="level-row">
          <% if is_completed %>
            <div class="level-node node-completed <%= 'node-final' if is_final %>">
              <span class="node-icon">
                <% if is_final %>
                  <i class="fa-solid fa-torii-gate"></i>
                <% else %>
                  <i class="fa-solid fa-star"></i>
                <% end %>
              </span>
              <span class="node-label"><%= is_final ? 'Complete' : level.id %></span>
            </div>
          <% elsif is_current %>
            <div class="current-level-wrapper" data-scroll-to-current-level-target="current">
              <%= button_to fights_path, method: :post, class: "level-node node-current #{'node-current-final' if is_final}" do %>
                <span class="node-icon">
                  <% if is_final %>
                    <i class="fa-solid fa-torii-gate"></i>
                  <% else %>
                    <i class="fa-solid fa-play"></i>
                  <% end %>
                </span>
                <span class="node-label"><%= is_final ? 'Final' : level.id %></span>
              <% end %>

              <div class="story-bubble">
                <div class="story-bubble-content">
                  <%= @current_level&.story_content %>
                </div>
              </div>
            </div>
          <% else %>
            <% if is_final %>
              <div class="level-node node-locked node-final <%= 'node-final-close' if @accessible_level_id >= 7 %>">
                <span class="node-icon"><i class="fa-solid fa-torii-gate"></i></span>
                <span class="node-icon-lock"><i class="fa-solid fa-lock"></i></span>
              </div>
            <% else %>
              <div class="level-node node-locked">
                <span class="node-icon"><i class="fa-solid fa-lock"></i></span>
                <span class="node-label"><%= level.id %></span>
              </div>
            <% end %>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<%= render 'shared/bottom_navbar' %>
