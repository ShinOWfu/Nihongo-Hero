<!-- app/views/story_levels/map.html.erb -->
<!-- We can hide navbar because of new log-out button on the bottom right -->
<% content_for :hide_navbar, true %>

<!-- Toast Notification for Level 10 Completion -->
<% if flash[:level_10_complete] %>
  <div class="toast-notification">
    <div class="toast-body">
      üéâ Last level Complete!
    </div>
  </div>
<% end %>
<!-- Main Map Container with dynamic background image, default in case current level does not contain an image -->
<div class="map-container" style="background-image: url('<%= asset_path(@current_level&.map_image || 'default.jpg') %>');">
  <!-- Overlay for map content with Stimulus controller for scroll to current level on page load -->
  <div class="map-overlay" id="map-scroll" data-controller="scroll-to-current-level">
    <div class="map-header">
      <h1 class="map-title">Your Journey</h1>
      <p class="map-subtitle">
        <% if @all_complete %>
          All Levels Complete! <i class="fa-solid fa-crown"></i>
        <% else %>
          Level <%= @accessible_level_id %> of <%= @story_levels.count %>
        <% end %>
      </p>
    </div>

    <div class="level-path">
      <!-- Finish Line at the top -->
      <div class="finish-line">
        <span class="finish-icon"><i class="fa-solid fa-torii-gate"></i></span>
        <span class="finish-label">Final Battle</span>
      </div>

      <!-- Reverse due to start from the bottom -->
      <% @story_levels.reverse_each do |level| %>
        <%
          is_completed = @completed_level_ids.include?(level.id)
          is_current   = level.id == @accessible_level_id
          is_locked    = level.id > @accessible_level_id
        %>

        <div class="level-row">
          <% if is_completed %>
            <div class="level-node node-completed">
              <span class="node-icon"><i class="fa-solid fa-check"></i></span>
              <span class="node-label"><%= level.id %></span>
            </div>
          <% elsif is_current %>
            <div class="current-level-wrapper" data-scroll-to-current-level-target="current">
              <%= button_to fights_path, method: :post, class: "level-node node-current" do %>
                <span class="node-icon"><i class="fa-solid fa-play"></i></span>
                <span class="node-label"><%= level.id %></span>
              <% end %>

              <!-- Story content attached to current level, Stimulus will center this bubble in the middle of the screen on page load -->
              <div class="story-bubble">
                <div class="story-bubble-content">
                  <% if @all_complete %>
                    „ÅîËã¶Âä¥Êßò„Åß„ÅôÔºÅ
                  <% else %>
                    <%= @current_level&.story_content %>
                  <% end %>
                </div>
              </div>
            </div>
          <% else %>
            <div class="level-node node-locked">
              <span class="node-icon"><i class="fa-solid fa-lock"></i></span>
              <span class="node-label"><%= level.id %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<nav class="bottom-nav">
  <!-- Bookmarks Link (Placeholder for now, does nothing) -->
  <%= link_to "#", class: "nav-item" do %>
    <span class="nav-icon"><i class="fa-solid fa-bookmark"></i></span>
    <span class="nav-label">Bookmarks</span>
  <% end %>

  <!-- Map Link (Active status) -->
  <%= link_to map_path, class: "nav-item nav-item-active" do %>
    <span class="nav-icon"><i class="fa-solid fa-map"></i></span>
    <span class="nav-label">My Journey</span>
  <% end %>

  <!-- Profile but it's just a Logout Link -->
  <%= link_to destroy_user_session_path, data: { turbo_method: :delete }, class: "nav-item" do %>
    <span class="nav-icon"><i class="fa-solid fa-user"></i></span>
    <span class="nav-label">My Profile</span>
  <% end %>
</nav>
